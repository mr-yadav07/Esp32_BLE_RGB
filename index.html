<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ESP32 BLE Mobile Control</title>
<style>
  body{font-family:sans-serif;margin:0;display:flex;flex-direction:column;height:100vh}
  #deviceList{flex:1;overflow:auto;padding:8px;background:#f7f7f7}
  .deviceRow{display:flex;align-items:center;justify-content:space-between;padding:8px;margin:6px 0;border-radius:6px;background:#fff;border:1px solid #ddd}
  .devInfo{flex:1;margin-right:8px}
  .selectedDot{width:12px;height:12px;border-radius:50%}
  .active{box-shadow:0 0 0 3px rgba(0,128,255,0.12)}
  .offline button.connBtn{background:#ccc;color:#666;cursor:not-allowed}
  #controls{padding:10px;background:#ededed;border-top:1px solid #ccc}
  #sliders{display:flex;flex-direction:column;gap:8px;margin-bottom:8px}
  .sliderRow{display:flex;align-items:center;gap:8px}
  .sliderRow label{width:30px}
  input[type=range]{flex:1}
  button{padding:8px 12px;margin:2px;border:none;border-radius:6px;background:#1976d2;color:#fff;cursor:pointer}
  button:disabled{background:#ccc;color:#666;cursor:not-allowed}
  #status{height:90px;overflow:auto;background:#111;color:#0f0;font-family:monospace;font-size:12px;padding:6px;border-radius:6px;margin-top:6px}
</style>
</head>
<body>
  <div id="deviceList"></div>

  <div id="controls">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="btnScan" style="flex:1">Scan</button>
      <button id="btnSync" style="flex:1">Sync Selected</button>
    </div>

    <div id="sliders">
      <div class="sliderRow"><label>R</label><input id="redSlider" type="range" min="0" max="255"></div>
      <div class="sliderRow"><label>G</label><input id="greenSlider" type="range" min="0" max="255"></div>
      <div class="sliderRow"><label>B</label><input id="blueSlider" type="range" min="0" max="255"></div>
    </div>

    <div style="display:flex;gap:8px">
      <button id="btnLedOn" style="flex:1;background:#2e7d32">LED ON</button>
      <button id="btnLedOff" style="flex:1;background:#c62828">LED OFF</button>
    </div>

    <div id="status"></div>
  </div>

<script>
const SERVICE = '12345678-1234-1234-1234-1234567890ab';
const COLOR_UUID = '87654321-4321-4321-4321-abcdefabcdef';
const LED_UUID   = 'abcdefab-cdef-cdef-cdef-1234567890ab';

let devices = []; // {device, server, colorChar, ledChar, selected, active, lastColor:[r,g,b], online}
let activeDevice = null;

const deviceListDiv = document.getElementById('deviceList');
const statusDiv = document.getElementById('status');
const btnScan = document.getElementById('btnScan');
const btnSync = document.getElementById('btnSync');
const redSlider = document.getElementById('redSlider');
const greenSlider = document.getElementById('greenSlider');
const blueSlider = document.getElementById('blueSlider');
const btnLedOn = document.getElementById('btnLedOn');
const btnLedOff = document.getElementById('btnLedOff');

function log(msg){
  const t = new Date().toLocaleTimeString();
  statusDiv.textContent += `[${t}] ${msg}\n`;
  statusDiv.scrollTop = statusDiv.scrollHeight;
}

function findEntryByDevice(dev){
  return devices.find(e=>e.device.id === dev.id);
}

function renderList(){
  deviceListDiv.innerHTML = '';
  devices.forEach((e)=>{
    const row = document.createElement('div');
    row.className = 'deviceRow' + (e.active ? ' active' : '') + (e.online ? '' : ' offline');
    const info = document.createElement('div');
    info.className = 'devInfo';
    info.innerHTML = `<strong>${e.device.name||e.device.id}</strong><div style="font-size:12px;color:#555">
      ${e.online ? 'online' : 'offline'} | last R=${e.lastColor[0]} G=${e.lastColor[1]} B=${e.lastColor[2]}</div>`;
    const controls = document.createElement('div');

    const sel = document.createElement('input');
    sel.type='checkbox'; sel.checked = !!e.selected;
    sel.onclick = (ev)=>{ e.selected = ev.target.checked; };

    const act = document.createElement('button');
    act.textContent = 'Edit';
    act.onclick = ()=>{ setActive(e); };

    const conn = document.createElement('button');
    conn.className = 'connBtn';
    conn.textContent = e.online ? 'Disconnect' : 'Connect';
    conn.disabled = false;
    conn.onclick = ()=>{ e.online ? disconnectEntry(e) : connectEntry(e); };

    controls.appendChild(sel);
    controls.appendChild(act);
    controls.appendChild(conn);

    row.appendChild(info);
    row.appendChild(controls);
    deviceListDiv.appendChild(row);
  });
}

async function scanAndAdd(){
  try {
    const dev = await navigator.bluetooth.requestDevice({acceptAllDevices:true, optionalServices:[SERVICE]});
    if(findEntryByDevice(dev)) { log('Device already in list'); return; }
    const entry = { device: dev, server: null, colorChar:null, ledChar:null, selected:false, active:false, lastColor:[0,0,0], online:false };
    devices.push(entry);
    renderList();
    log('Added: ' + (dev.name||dev.id));
    await connectEntry(entry);
  } catch(err){ log('Scan error: '+err); }
}

async function connectEntry(entry){
  try {
    log('Connecting '+(entry.device.name||entry.device.id));
    entry.server = await entry.device.gatt.connect();
    entry.device.addEventListener('gattserverdisconnected', ()=> {
      entry.online = false;
      log('Disconnected: '+(entry.device.name||entry.device.id));
      renderList();
      setTimeout(()=>connectEntry(entry).catch(()=>{}), 1000);
    });
    const svc = await entry.server.getPrimaryService(SERVICE);
    entry.colorChar = await svc.getCharacteristic(COLOR_UUID);
    entry.ledChar = await svc.getCharacteristic(LED_UUID);

    try {
      await entry.colorChar.startNotifications();
      entry.colorChar.addEventListener('characteristicvaluechanged', (ev)=>{
        const data = ev.target.value;
        if (data.byteLength >= 3) {
          const r = data.getUint8(0), g = data.getUint8(1), b = data.getUint8(2);
          entry.lastColor = [r,g,b];
          entry.online = true;
          if (entry === activeDevice) setSlidersFromEntry(entry);
          renderList();
        }
      });
    } catch(err){ log('Notif error: '+err); }

    try {
      const v = await entry.colorChar.readValue();
      if (v.byteLength >= 3) entry.lastColor = [v.getUint8(0), v.getUint8(1), v.getUint8(2)];
    } catch(e){}

    entry.online = true;
    log('Connected: '+(entry.device.name||entry.device.id));
    if (!activeDevice) setActive(entry); // auto-select first connected device
    renderList();
  } catch(err){
    entry.online = false;
    log('Connect failed: '+(entry.device.name||entry.device.id)+' : '+err);
    renderList();
  }
}

async function disconnectEntry(entry){
  try {
    if (entry.device && entry.device.gatt && entry.device.gatt.connected) {
      entry.device.gatt.disconnect();
      entry.online = false;
      log('Force disconnect: '+(entry.device.name||entry.device.id));
    }
  } catch(e){ log('Disconnect error: '+e); }
}

function setActive(entry){
  devices.forEach(e=>e.active=false);
  entry.active = true;
  activeDevice = entry;
  setSlidersFromEntry(entry);
  renderList();
  log('Editing: '+(entry.device.name||entry.device.id));
}

function setSlidersFromEntry(entry){
  redSlider.value = entry.lastColor[0];
  greenSlider.value = entry.lastColor[1];
  blueSlider.value = entry.lastColor[2];
}

async function sendToActive(){
  if(!activeDevice || !activeDevice.online || !activeDevice.colorChar) { return; }
  const r = Number(redSlider.value)|0;
  const g = Number(greenSlider.value)|0;
  const b = Number(blueSlider.value)|0;
  const data = new Uint8Array([r,g,b]);
  try {
    await activeDevice.colorChar.writeValue(data);
    log(`Sent to ${activeDevice.device.name||activeDevice.device.id}: R=${r} G=${g} B=${b}`);
    activeDevice.lastColor = [r,g,b];
    renderList();
  } catch(err) {
    log('Write error to active: '+err);
  }
}

async function syncSelected(){
  const r = Number(redSlider.value)|0;
  const g = Number(greenSlider.value)|0;
  const b = Number(blueSlider.value)|0;
  const data = new Uint8Array([r,g,b]);
  const targets = devices.filter(d=>d.selected && d.online && d.colorChar);
  if(targets.length===0){ log('No selected online devices'); return; }
  for(const e of targets){
    try {
      await e.colorChar.writeValue(data);
      e.lastColor = [r,g,b];
      log(`Sync -> ${e.device.name||e.device.id}`);
    } catch(err){ log('Sync write fail '+(e.device.name||e.device.id)+' : '+err); }
  }
  renderList();
}

async function setLedStateOnSelected(state){
  const targets = devices.filter(d=>d.selected && d.online && d.ledChar);
  if(targets.length===0){ log('No selected online devices for LED'); return; }
  const data = new Uint8Array([state?1:0]);
  for(const e of targets){
    try {
      await e.ledChar.writeValue(data);
      log(`LED ${state?'ON':'OFF'} -> ${e.device.name||e.device.id}`);
    } catch(err){ log('LED write fail '+(e.device.name||e.device.id)+' : '+err); }
  }
}

btnScan.onclick = scanAndAdd;
btnSync.onclick = syncSelected;
btnLedOn.onclick = ()=>setLedStateOnSelected(1);
btnLedOff.onclick = ()=>setLedStateOnSelected(0);

let throttleTimer = null;
function sliderChanged(){
  if (throttleTimer) clearTimeout(throttleTimer);
  throttleTimer = setTimeout(()=>{ sendToActive(); throttleTimer=null; }, 80);
}
redSlider.oninput = sliderChanged;
greenSlider.oninput = sliderChanged;
blueSlider.oninput = sliderChanged;

renderList();
log('App ready');
</script>
</body>
</html>
