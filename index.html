<script>
const SERVICE = '12345678-1234-1234-1234-1234567890ab';
const COLOR_UUID = '87654321-4321-4321-4321-abcdefabcdef';
const LED_UUID   = 'abcdefab-cdef-cdef-cdef-1234567890ab';

let devices = []; 
let activeDevice = null;

const deviceListDiv = document.getElementById('deviceList');
const statusDiv = document.getElementById('status');
const btnScan = document.getElementById('btnScan');
const btnSync = document.getElementById('btnSync');
const redSlider = document.getElementById('redSlider');
const greenSlider = document.getElementById('greenSlider');
const blueSlider = document.getElementById('blueSlider');
const btnLedOn = document.getElementById('btnLedOn');
const btnLedOff = document.getElementById('btnLedOff');

function log(msg){
  const t = new Date().toLocaleTimeString();
  statusDiv.textContent += `[${t}] ${msg}\n`;
  statusDiv.scrollTop = statusDiv.scrollHeight;
}

function findEntryByDevice(dev){
  return devices.find(e=>e.device.id === dev.id);
}

function renderList(){
  deviceListDiv.innerHTML = '';
  devices.forEach(e=>{
    const row = document.createElement('div');
    row.className = 'deviceRow' + (e.active ? ' active' : '');
    const info = document.createElement('div');
    info.className = 'devInfo';
    info.innerHTML =
      `<strong>${e.device.name||e.device.id}</strong>
       <div style="font-size:12px;color:#555">
       ${e.online?'online':'offline'} | last R=${e.lastColor[0]} G=${e.lastColor[1]} B=${e.lastColor[2]}
       </div>`;
    const controls = document.createElement('div');

    const sel = document.createElement('input');
    sel.type='checkbox'; sel.checked = !!e.selected;
    sel.onclick = ev=>{ e.selected = ev.target.checked; renderList(); };

    const act = document.createElement('button');
    act.textContent = 'Edit';
    act.onclick = ()=> setActive(e);

    const conn = document.createElement('button');
    conn.textContent = e.online ? 'Disconnect' : 'Connect';
    conn.onclick = ()=> e.online ? disconnectEntry(e) : connectEntry(e);

    controls.appendChild(sel);
    controls.appendChild(act);
    controls.appendChild(conn);

    row.appendChild(info);
    row.appendChild(controls);
    deviceListDiv.appendChild(row);
  });
}

async function scanAndAdd(){
  try {
    const dev = await navigator.bluetooth.requestDevice({
      acceptAllDevices:true,
      optionalServices:[SERVICE]
    });
    
    if(findEntryByDevice(dev)){
      log("Already added"); return;
    }

    const entry = {
      device: dev, server:null, colorChar:null, ledChar:null,
      selected:false, active:false, lastColor:[0,0,0],
      online:false, userInteracting:false
    };

    devices.push(entry);
    renderList();
    await connectEntry(entry);
  } catch(e){ log("Scan error "+e); }
}

async function connectEntry(entry){
  try {
    entry.server = await entry.device.gatt.connect();

    entry.device.addEventListener("gattserverdisconnected", ()=>{
      entry.online = false;
      renderList();
      setTimeout(()=> connectEntry(entry).catch(()=>{}), 1000);
    });

    const svc = await entry.server.getPrimaryService(SERVICE);
    entry.colorChar = await svc.getCharacteristic(COLOR_UUID);
    entry.ledChar   = await svc.getCharacteristic(LED_UUID);
    
    // Notifications for lastColor – but ignore during slider drag
    await entry.colorChar.startNotifications();
    entry.colorChar.addEventListener("characteristicvaluechanged", ev=>{
      if(entry.userInteracting) return; // ignore while dragging slider
      const v = ev.target.value;
      if(v.byteLength >= 3){
        entry.lastColor = [v.getUint8(0), v.getUint8(1), v.getUint8(2)];
        if(entry === activeDevice){
          redSlider.value = entry.lastColor[0];
          greenSlider.value = entry.lastColor[1];
          blueSlider.value = entry.lastColor[2];
        }
        renderList();
      }
    });

    // Optional initial read
    try {
      const v = await entry.colorChar.readValue();
      if(v.byteLength>=3)
        entry.lastColor = [v.getUint8(0), v.getUint8(1), v.getUint8(2)];
    } catch{}

    entry.online = true;
    renderList();

  } catch(err){
    entry.online = false;
    renderList();
  }
}

async function disconnectEntry(entry){
  try{
    entry.device.gatt.disconnect();
    entry.online = false;
    renderList();
  } catch(e){}
}

function setActive(entry){
  devices.forEach(e=> e.active=false);
  entry.active = true;
  activeDevice = entry;

  // set slider based on lastColor
  redSlider.value = entry.lastColor[0];
  greenSlider.value = entry.lastColor[1];
  blueSlider.value = entry.lastColor[2];

  renderList();
}

// --------------------
// NEW: REAL-TIME BROADCAST TO ALL SELECTED DEVICES
// --------------------
async function broadcastColor(r,g,b){
  const targets = devices.filter(d=>d.selected && d.online && d.colorChar);
  const arr = new Uint8Array([r,g,b]);

  for(const e of targets){
    try {
      await e.colorChar.writeValue(arr);
      e.lastColor = [r,g,b];
    } catch(err){ log("Write fail "+err); }
  }
  renderList();
}

// --------------------
// Slider handling (smooth, glitch-free)
// --------------------
let sliderTimer = null;

function sliderChanged(){
  if(!activeDevice) return;

  activeDevice.userInteracting = true;

  const r = +redSlider.value;
  const g = +greenSlider.value;
  const b = +blueSlider.value;

  if(sliderTimer) clearTimeout(sliderTimer);

  sliderTimer = setTimeout(()=>{
    // Broadcast to all selected devices
    broadcastColor(r,g,b);

    activeDevice.userInteracting = false;
  }, 50); // fast + smooth
}

// --------------------
// Sync button → force broadcast
// --------------------
async function syncSelected(){
  const r = +redSlider.value;
  const g = +greenSlider.value;
  const b = +blueSlider.value;
  broadcastColor(r,g,b);
}

// LED control
async function setLedStateOnSelected(state){
  const targets = devices.filter(d=>d.selected && d.online && d.ledChar);
  const arr = new Uint8Array([state?1:0]);

  for(const e of targets){
    try{
      await e.ledChar.writeValue(arr);
    }catch(err){}
  }
}

btnScan.onclick = scanAndAdd;
btnSync.onclick = syncSelected;
btnLedOn.onclick = ()=>setLedStateOnSelected(1);
btnLedOff.onclick = ()=>setLedStateOnSelected(0);

redSlider.oninput = sliderChanged;
greenSlider.oninput = sliderChanged;
blueSlider.oninput = sliderChanged;

renderList();
log("App ready");
</script>
</body>
</html>